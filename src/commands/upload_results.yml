description: >
  Uploads CodeQL analysis results to GitHub, differentiating between pull request and branch builds.
parameters:
  codeql_path:
    type: string
    default: "/home/circleci/codeql/codeql"

steps:
  - run:
      name: "Extract Repository Information"
      command: <<include(scripts/parse_repository.sh)>>
  - when:
      condition: ${CIRCLE_PULL_REQUEST}
      steps:
        - run:
            name: "Upload CodeQL Results for PR"
            command: |
              << parameters.codeql_path >> github upload-results \
                --repository=$repo \
                --ref=refs/pull/${CIRCLE_PULL_REQUEST##*/}/head \
                --commit=$CIRCLE_SHA1 \
                --sarif=$SARIF_FILE_PATH \
                --github-url=https://github.com/ \
                --github-auth-stdin \<<< "$GITHUB_TOKEN"

  - unless:
      condition: ${CIRCLE_PULL_REQUEST}
      steps:
        - run:
            name: "Upload CodeQL Results for Branch"
            command: |
              << parameters.codeql_path >> github upload-results \
                --repository=$repo \
                --ref=refs/heads/${CIRCLE_BRANCH} \
                --commit=$CIRCLE_SHA1 \
                --sarif=$SARIF_FILE_PATH \
                --github-url=https://github.com/ \
                --github-auth-stdin \<<< "$GITHUB_TOKEN"
