description: >
  Uploads CodeQL analysis results to GitHub, differentiating between pull request and branch builds.
parameters:
  codeql_path:
    type: string
    default: "./codeql/codeql"
  sarif_file_path:
    type: string
    default: "./codeql/temp/results-js.sarif"
  github_url:
    type: string
    default: "https://github.com/"
steps:
  - run:
      name: "Print Working Directory"
      command: pwd
  - when:
      condition: ${CIRCLE_PULL_REQUEST}
      steps:
        - run:
            name: "Upload CodeQL Results for PR"
            command: |
              repo=$(echo $CIRCLE_REPOSITORY_URL | cut -d'/' -f4,5 | sed 's/\.git$//')
              echo $GITHUB_TOKEN | << parameters.codeql_path >> github upload-results \
                --repository=$repo \
                --ref=refs/pull/${CIRCLE_PULL_REQUEST##*/}/head \
                --commit=$CIRCLE_SHA1 \
                --sarif=<< parameters.sarif_file_path >> \
                --github-url=<< parameters.github_url >> \
                --github-auth-stdin
  - unless:
      condition: ${CIRCLE_PULL_REQUEST}
      steps:
        - run:
            name: "Upload CodeQL Results for Branch"
            command: |
              repo=$(echo $CIRCLE_REPOSITORY_URL | cut -d'/' -f4,5 | sed 's/\.git$//')
              echo $GITHUB_TOKEN | << parameters.codeql_path >> github upload-results \
                --repository=$repo \
                --ref=refs/heads/${CIRCLE_BRANCH} \
                --commit=$CIRCLE_SHA1 \
                --sarif=<< parameters.sarif_file_path >> \
                --github-url=<< parameters.github_url >> \
                --github-auth-stdin
