description: >
  Uploads CodeQL analysis results to GitHub, differentiating between pull request and branch builds.
# What will this command do?
# Descriptions should be short, simple, and clear.
parameters:
  github_token:
    type: env_var_name
    description: "Environment variable name containing the GitHub token."
  repository:
    type: string
    description: "The GitHub repository in the format 'org/repo'."
  codeql_path:
    type: string
    default: "./codeql/codeql"
    description: "Path to the CodeQL CLI."
  sarif_file_path:
    type: string
    default: "./codeql/temp/results-js.sarif"
    description: "Path to the SARIF file generated by CodeQL."
  github_url:
    type: string
    default: "https://github.com/"
    description: "GitHub URL, useful for GitHub Enterprise with a custom URL."
steps:
  - when:
      condition: << pipeline.parameters.CIRCLE_PULL_REQUEST >>
      steps:
        - run:
            name: "Upload CodeQL Results for PR"
            command: |
              echo $<< parameters.github_token >> | << parameters.codeql_path >> github upload-results \
                --repository=<< parameters.repository >> \
                --ref=refs/pull/${CIRCLE_PULL_REQUEST##*/}/head \
                --commit=$CIRCLE_SHA1 \
                --sarif=<< parameters.sarif_file_path >> \
                --github-url=<< parameters.github_url >> \
                --github-auth-stdin
  - unless:
      condition: << pipeline.parameters.CIRCLE_PULL_REQUEST >>
      steps:
        - run:
            name: "Upload CodeQL Results for Branch"
            command: |
              echo $<< parameters.github_token >> | << parameters.codeql_path >> github upload-results \
                --repository=<< parameters.repository >> \
                --ref=refs/heads/${CIRCLE_BRANCH} \
                --commit=$CIRCLE_SHA1 \
                --sarif=<< parameters.sarif_file_path >> \
                --github-url=<< parameters.github_url >> \
                --github-auth-stdin